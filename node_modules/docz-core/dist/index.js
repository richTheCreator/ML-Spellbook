"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var fs=require("fs"),path=require("path"),resolve=_interopDefault(require("resolve")),prettier=require("prettier"),logger=_interopDefault(require("signale")),fs$1=require("fs-extra"),artTemplate=require("art-template"),vfile=_interopDefault(require("to-vfile")),unified=_interopDefault(require("unified")),remark=_interopDefault(require("remark-parse")),matter=_interopDefault(require("remark-frontmatter")),slug=_interopDefault(require("remark-slug")),parseFrontmatter=_interopDefault(require("remark-parse-yaml")),humanize=_interopDefault(require("humanize-string")),get=_interopDefault(require("lodash.get")),crypto=require("crypto"),slugify=_interopDefault(require("@sindresorhus/slugify")),find=_interopDefault(require("unist-util-find")),is=_interopDefault(require("unist-util-is")),visit=_interopDefault(require("unist-util-visit")),getPkgRepo=_interopDefault(require("get-pkg-repo")),findup=_interopDefault(require("find-up")),glob=_interopDefault(require("fast-glob")),chokidar=_interopDefault(require("chokidar")),equal=_interopDefault(require("fast-deep-equal")),loadCfg=require("load-cfg"),WS=_interopDefault(require("ws")),merge=_interopDefault(require("deepmerge")),slug$1=_interopDefault(require("rehype-slug")),remarkDocz=_interopDefault(require("remark-docz")),rehypeDocz=_interopDefault(require("rehype-docz")),HappyPack=_interopDefault(require("happypack")),envDotProp=_interopDefault(require("env-dot-prop")),ctags=require("common-tags"),miniHtmlWebpack=require("mini-html-webpack-plugin"),miniHtmlWebpack__default=_interopDefault(miniHtmlWebpack),webpackBarPlugin=_interopDefault(require("webpackbar")),Config=_interopDefault(require("webpack-chain")),htmlMinifier=require("html-minifier"),friendlyErrors=_interopDefault(require("friendly-errors-webpack-plugin")),manifestPlugin=_interopDefault(require("webpack-manifest-plugin")),UglifyJs=_interopDefault(require("uglifyjs-webpack-plugin")),mount=_interopDefault(require("koa-mount")),range=_interopDefault(require("koa-range")),convert=_interopDefault(require("koa-connect")),serveStatic=_interopDefault(require("koa-static")),history=_interopDefault(require("connect-history-api-fallback")),serveWaitpage=_interopDefault(require("webpack-serve-waitpage")),serve=_interopDefault(require("webpack-serve")),chalk=_interopDefault(require("chalk")),webpack=_interopDefault(require("webpack")),FSR=_interopDefault(require("react-dev-utils/FileSizeReporter")),formatWebpackMessages=_interopDefault(require("react-dev-utils/formatWebpackMessages")),printBuildError=_interopDefault(require("react-dev-utils/printBuildError")),detectPort=_interopDefault(require("detect-port")),titleize=_interopDefault(require("titleize"));function __rest(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&0>t.indexOf(s)&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(s=Object.getOwnPropertySymbols(e);s.length>a;a++)0>t.indexOf(s[a])&&(r[s[a]]=e[s[a]])}return r}const ensureSlash=(e,t)=>{const r=e.endsWith("/");return r&&!t?e.substr(e,e.length-1):!r&&t?`${e}/`:e},root=fs.realpathSync(process.cwd()),resolveApp=e=>path.resolve(root,e),resolveOwn=e=>path.resolve(__dirname,"../",e),templates=path.join(resolve.sync("docz-core"),"../templates"),packageJson=resolveApp("package.json"),servedPath=e=>ensureSlash(e,!0),docz=resolveApp(".docz"),app=path.resolve(docz,"app/"),cache=path.resolve(docz,"cache/"),appPublic=path.resolve(docz,"public/"),appNodeModules=resolveApp("node_modules"),appPackageJson=resolveApp("package.json"),ownNodeModules=resolveOwn("node_modules"),getDist=e=>path.join(root,e),distPublic=e=>path.join(e,"public/"),importsJs=path.resolve(app,"imports.js"),rootJs=path.resolve(app,"root.jsx"),indexJs=path.resolve(app,"index.jsx"),indexHtml=path.resolve(app,"index.html"),db=path.resolve(app,"db.json");var paths=Object.freeze({root:root,resolveApp:resolveApp,resolveOwn:resolveOwn,templates:templates,packageJson:packageJson,servedPath:servedPath,docz:docz,app:app,cache:cache,appPublic:appPublic,appNodeModules:appNodeModules,appPackageJson:appPackageJson,ownNodeModules:ownNodeModules,getDist:getDist,distPublic:distPublic,importsJs:importsJs,rootJs:rootJs,indexJs:indexJs,indexHtml:indexHtml,db:db});const format=e=>new Promise((t,r)=>{try{t(prettier.format(e,{parser:"babylon",semi:!1,singleQuote:!0,trailingComma:"all"}))}catch(e){logger.fatal(e),t(e)}}),touch=(e,t)=>new Promise(async(r,s)=>{const a=/jsx?$/.test(path.extname(e))?await format(t):t,i=fs$1.createWriteStream(e);i.write(a,"utf-8"),i.on("finish",()=>r()),i.on("error",e=>s(e)),i.end()}),read=e=>new Promise((t,r)=>{let s="";const a=fs$1.createReadStream(e,{encoding:"utf-8"});a.on("data",e=>s+=e),a.on("end",()=>t(s)),a.on("error",e=>r(e))}),compiled=async(e,t={})=>read(e).then(e=>artTemplate.compile(e,t)).catch(e=>e),{keys:keys}=Object,isFn=e=>"function"==typeof e;function omit(e,t){return keys(t).filter(t=>-1===e.indexOf(t)).reduce((e,r)=>Object.assign({},e,{[r]:t[r]}),{})}const mapToObj=e=>Array.from(e.entries()).reduce((e,[t,r])=>Object.assign({},e,{[`${t}`]:r}),{}),parseMdx=e=>{const t=vfile.readSync(e,"utf-8"),r=unified().use(remark,{type:"yaml",marker:"-"}).use(matter).use(parseFrontmatter).use(slug);return r.run(r.parse(t))},valueFromHeading=e=>{const t=get(e,"children"),r=get(e,"data.id");return Array.isArray(t)?t.map(e=>e.value).filter(Boolean).join(" "):humanize(r)},getParsedData=e=>{const t=find(e,e=>is("yaml",e));return get(t,"data.parsedValue")||{}},getHeadings=e=>{const t=[];return visit(e,"heading",e=>{const r=get(e,"data.id"),s=get(e,"depth");t.push({depth:s,slug:r,value:valueFromHeading(e)})}),t},createId=e=>crypto.createHash("md5").update(e).digest("hex");class Entry{constructor(e,t,r){const s=this.getFilepath(t,r),a=getParsedData(e),i=this.getName(s,a);this.id=createId(t),this.filepath=s,this.link=null,this.slug=this.slugify(s),this.route=this.getRoute(a),this.name=i,this.order=a.order||0,this.menu=a.menu||null,this.headings=getHeadings(e),this.settings=a}setLink(e){e&&(this.link=e.replace("{{filepath}}",this.filepath))}getFilepath(e,t){const r=path.resolve(root,t),s=path.relative(r,e);return"win32"===process.platform?s.split("\\").join("/"):s}getName(e,t){const r=humanize(path.parse(e).name);return t&&t.name?t.name:r}slugify(e){const t=path.extname(e),r=e.replace(t,"");return slugify(r)}getRoute(e){return e&&e.route?e.route:`/${this.slug}`}}class Plugin{constructor(e){this.setConfig=e.setConfig,this.modifyBundlerConfig=e.modifyBundlerConfig,this.modifyBabelRc=e.modifyBabelRc,this.onCreateApp=e.onCreateApp,this.onServerListening=e.onServerListening,this.onPreBuild=e.onPreBuild,this.onPostBuild=e.onPostBuild,this.onPreRender=e.onPreRender,this.onPostRender=e.onPostRender}static runPluginsMethod(e){return(t,...r)=>{if(e&&e.length>0)for(const s of e){const e=get(s,t);isFn(e)&&e(...r)}}}static propsOfPlugins(e){return t=>e&&e.length>0?e.map(e=>get(e,t)).filter(Boolean):[]}static reduceFromPlugins(e){return(t,r,...s)=>[...e||[]].reduce((e,r)=>{const a=get(r,t);return a&&isFn(a)?a(e,...s):e},r)}}function createPlugin(e){return new Plugin(e)}const parseRepo=()=>{try{const e=fs$1.readJsonSync(appPackageJson);return getPkgRepo(e)}catch(e){return null}},getRepoUrl=()=>{const e=parseRepo();return e&&e.browsetemplate&&e.browsetemplate.replace("{domain}",e.domain).replace("{user}",e.user).replace("{project}",e.project).replace("{/tree/committish}","")},getBitBucketPath=(e,t)=>{const r=`?mode=edit&spa=0&at=${e}&fileviewer=file-view-default`;return`${path.join(`/src/${e}`,t,"{{filepath}}")}${r}`},getTree=(e,t,r)=>{const s=path.join(`/edit/${t}`,r,"{{filepath}}"),a=getBitBucketPath(t,r);return e&&"bitbucket"===e.type?a:s},getRepoEditUrl=(e,t)=>{try{const r=parseRepo(),s=path.parse(findup.sync(".git")).dir,a=path.join(root,e),i=path.relative(s,a),o=getTree(r,t,i);return r&&r.browsetemplate&&r.browsetemplate.replace("{domain}",r.domain).replace("{user}",r.user).replace("{project}",r.project).replace("{/tree/committish}",o)}catch(e){return null}},DEFAULT_IGNORE=["!**/node_modules/**","readme.md","changelog.md","code_of_conduct.md","contributing.md","license.md"],fromTemplates=e=>path.join(templates,e),matchFilesWithSrc=e=>t=>{const r=path.relative(root,e.src);return t.map(e=>e.startsWith(r)?e:path.join(r,e))},writeAppFiles=async(e,t)=>{const{plugins:r,theme:s}=e,a=Plugin.propsOfPlugins(r),i=a("onPreRender"),o=a("onPostRender"),n=await compiled(fromTemplates("root.tpl.js")),l=await compiled(fromTemplates("index.tpl.js")),p=n({theme:s,isProd:!t,wrapper:e.wrapper,hashRouter:e.hashRouter,websocketUrl:`ws://${e.websocketHost}:${e.websocketPort}`}),c=l({onPreRenders:i,onPostRenders:o,isProd:!t});await fs$1.remove(rootJs),await fs$1.remove(indexJs),await touch(rootJs,p),await touch(indexJs,c)};class Entries{static async writeApp(e,t){await fs$1.ensureDir(app),await writeAppFiles(e,!!t)}constructor(e){this.repoEditUrl=getRepoEditUrl(e.src,e.editBranch),this.all=new Map,this.get=(async()=>this.getMap(e))}async getMap(e){const{src:t,files:r,ignore:s}=e,a=Array.isArray(r)?r:[r],i=matchFilesWithSrc(e),o=await glob(i(a),{ignore:DEFAULT_IGNORE.concat(s),onlyFiles:!0,unique:!0,nocase:!0,matchBase:!0}),n=new Map,l=await Promise.all(o.map(async e=>{try{const r=await parseMdx(e),s=new Entry(r,e,t);this.repoEditUrl&&s.setLink(this.repoEditUrl);const{settings:a}=s,i=__rest(s,["settings"]);return Object.assign({},a,i)}catch(e){return null}}).filter(Boolean));for(const e of l)e&&n.set(e.filepath,e);return this.all=n,mapToObj(n)}}const writeImports=async e=>{const t=(await compiled(fromTemplates("imports.tpl.js")))({entries:Object.values(e)});await touch(path.join(app,"imports.js"),t)},updateEntries=e=>async t=>{const r=t.state.entries,s=await e.get();s&&!equal(r,s)&&(await writeImports(s),t.setState("entries",s))},state=e=>{const t=new Entries(e),r=path.relative(root,e.src),s=path.join(r,e.files),a=chokidar.watch(s,{cwd:root,ignored:/(^|[\/\\])\../,persistent:!0});return{init:updateEntries(t),update:async e=>{const r=updateEntries(t);return a.on("change",async()=>r(e)),a.on("unlink",async()=>r(e)),a.on("raw",async(t,s,a)=>{"moved"===a.event&&"directory"===a.type&&await r(e)}),()=>a.close()}}},getInitialConfig=e=>{const t=fs$1.readJsonSync(appPackageJson,{throws:!1}),r=getRepoUrl();return{title:e.title,description:e.description,themeConfig:e.themeConfig,ordering:e.ordering,version:get(t,"version"),repository:r,native:e.native}},updateConfig=e=>async t=>{const r=t.state.config,s=loadCfg.load("docz",getInitialConfig(e),!0);s&&!equal(r,s)&&t.setState("config",s)},state$1=e=>{const t=chokidar.watch(loadCfg.finds("docz"),{cwd:root,persistent:!0});return{init:updateConfig(e),update:async r=>{const s=updateConfig(e);return t.on("add",async()=>s(r)),t.on("change",async()=>s(r)),t.on("unlink",async()=>s(r)),()=>t.close()}}},isSocketOpened=e=>e.readyState===WS.OPEN,sender=e=>(t,r)=>{e&&isSocketOpened(e)&&e.send(JSON.stringify({type:t,payload:r}))};class DataServer{constructor(e,t,r){this.states=new Set,this.state={},e&&(this.server=new WS.Server({server:e,port:t,host:r}))}register(e){for(const t of e)this.states.add(t);return this}async init(){await Promise.all(Array.from(this.states).map(async e=>e.init&&e.init({state:Object.assign({},this.state),setState:this.setState()}))),await touch(db,JSON.stringify(this.state,null,2))}async listen(){this.server&&this.server.on("connection",e=>{const t=this.handleConnection(e);this.server.on("close",async()=>{await t()})})}handleConnection(e){const t=Array.from(this.states).map(async t=>t.update&&t.update({state:this.state,setState:this.setState(e)}));return async()=>{const e=await Promise.all(t.filter(Boolean));for(const t of e)t&&isFn(t)&&t()}}setState(e){const t=sender(e);return(e,r)=>{this.state[e]=r,t(`state.${e}`,r)}}}const getBabelConfig=async(e,t)=>{const r="production"===t,s=loadCfg.load("babel",{presets:[],plugins:[]}),a=[[require.resolve("babel-preset-docz"),{flow:!e.typescript,typescript:e.typescript,parseProps:e.propsParser&&!e.typescript}]],i=r?[]:[require.resolve("react-hot-loader/babel")],o=merge(s,{presets:a,plugins:i,cacheDirectory:!e.debug,babelrc:!1}),n=Plugin.reduceFromPlugins(e.plugins)("modifyBabelRc",o,e);return e.modifyBabelRc(n,e)};class Bundler{constructor(e){const{args:t,config:r,server:s,build:a}=e;this.args=t,this.config=r,this.server=s,this.builder=a}async getConfig(e){const t=await getBabelConfig(this.args,e),r=this.mountConfig(await this.config(t),e);return this.args.modifyBundlerConfig(r,!this.isProd(e),this.args)}async createServer(e){const t=Plugin.runPluginsMethod(this.args.plugins);return this.server(e,{onCreateApp(e){t("onCreateApp",e)},OnServerListening(e){t("onServerListening",e)}})}async build(e){const t=getDist(this.args.dest);root===path.resolve(t)&&(logger.fatal(Error('Unexpected option: "dest" cannot be set to the current working directory.')),process.exit(1)),await this.builder(e,t)}mountConfig(e,t){const{plugins:r}=this.args;return Plugin.reduceFromPlugins(r)("modifyBundlerConfig",e,!this.isProd(t),this.args)}isProd(e){return"production"===e}}const config={type:"yaml",marker:"-"},remarkPlugins=[matter,remarkDocz],rehypePlugins=[rehypeDocz,slug$1],setupHappypack=(e,t,r)=>{const s={id:"jsx",verbose:t.debug,loaders:[!t.debug&&{loader:require.resolve("cache-loader"),options:{cacheDirectory:cache}},{loader:require.resolve("babel-loader"),options:r}].filter(Boolean)};t.propsParser&&t.typescript&&s.loaders.push({loader:require.resolve("react-docgen-typescript-loader")});const a={id:"mdx",verbose:t.debug,loaders:[!t.debug&&{loader:require.resolve("cache-loader"),options:{cacheDirectory:cache}},{loader:require.resolve("babel-loader"),options:Object.assign({},r,{plugins:r.plugins.filter(e=>/react\-hot\-loader\/babel/.test(e)).filter(e=>/babel\-plugin\-react\-docgen/.test(e))})}].filter(Boolean)};e.plugin("happypack-jsx").use(HappyPack,[s]),e.plugin("happypack-mdx").use(HappyPack,[a])},js=(e,t)=>{const r=path.resolve(root,t.src);e.module.rule("js").test(/\.(js|jsx|mjs)$/).include.add(r).add(root).add(docz).end().exclude.add(/node_modules/).end().use("happypack-jsx").loader("happypack/loader?id=jsx")},ts=(e,t)=>{const r=path.resolve(root,t.src);e.module.rule("ts").test(/\.(ts|tsx)$/).include.add(r).add(root).end().exclude.add(/node_modules/).end().use("happypack-jsx").loader("happypack/loader?id=jsx")},mdx=(e,t)=>{const{mdPlugins:r,hastPlugins:s}=t,a=path.resolve(root,t.src);e.module.rule("mdx").test(/\.(md|markdown|mdx)$/).include.add(a).end().exclude.add(/node_modules/).end().use("happypack-mdx").loader("happypack/loader?id=mdx").end().use("mdx-loader").loader(require.resolve("@mdx-js/loader")).options(Object.assign({},config,{mdPlugins:r.concat(remarkPlugins),hastPlugins:s.concat(rehypePlugins)}))},INLINE_LIMIT=1e4,images=e=>{e.module.rule("images").test(/\.(png|jpe?g|gif)(\?.*)?$/).use("url-loader").loader(require.resolve("url-loader")).options({limit:1e4,name:"static/img/[name].[hash:8].[ext]"})},svg=e=>{e.module.rule("svg").test(/\.(svg)(\?.*)?$/).use("file-loader").loader(require.resolve("file-loader")).options({name:"static/img/[name].[hash:8].[ext]"})},media=e=>{e.module.rule("media").test(/\.(mp4|webm|ogg|mp3|wav|flac|aac)(\?.*)?$/).use("url-loader").loader(require.resolve("url-loader")).options({limit:1e4,name:"static/media/[name].[hash:8].[ext]"})},fonts=e=>{e.module.rule("fonts").test(/\.(woff2?|eot|ttf|otf)(\?.*)?$/i).use("url-loader").loader(require.resolve("url-loader")).options({limit:1e4,name:"static/fonts/[name].[hash:8].[ext]"})},populateNodePath=()=>(envDotProp.get("node.path")||"").split(path.delimiter).filter(e=>e&&!path.isAbsolute(e)).map(e=>path.resolve(root,e)).join(path.delimiter),configDotEnv=()=>{const e=envDotProp.get("node.env"),t=resolveApp(".env");[`${t}.${e}.local`,`${t}.${e}`,"test"!==e&&`${t}.local`,t].filter(Boolean).forEach(e=>{require("dotenv").config({path:e})})},setEnv=e=>{envDotProp.set("babel.env",e),envDotProp.set("node.env",e),configDotEnv(),populateNodePath()},getClientEnvironment=e=>{const t=/^(REACT_APP_)|(ANGULAR_APP_)|(VUE_APP_)|(DOCZ_)/i,r=Object.keys(process.env).filter(e=>t.test(e)).reduce((e,t)=>(e[t]=process.env[t],e),{NODE_ENV:envDotProp.get("node.env")||"development",PUBLIC_URL:e,WEBPACK_SERVE_OVERLAY_WS_URL:envDotProp.get("webpack.server.overlay.ws.url")}),s={"process.env":Object.keys(r).reduce((e,t)=>(e[t]=JSON.stringify(r[t]),e),{})};return{raw:r,stringified:s}},wrapItems=e=>Object.keys(e).map(t=>`${t}="${e[t]}"`).join(" "),generateTags=e=>(t=[])=>t.map(e).join(""),generateMetaTags=generateTags(e=>`<meta ${wrapItems(e)}>`),generateLinkTags=generateTags(e=>`<link ${wrapItems(e)}>`),generateScriptTags=generateTags(e=>`<script ${wrapItems(e)}><\/script>`),generateRawTags=(e=[])=>"string"==typeof e||e instanceof String?e:e.map(e=>e).join(""),getHtmlFilepath=e=>e?path.resolve(root,e):fromTemplates("index.tpl.html"),getPublicUrl=(e,t)=>{const r="/"===e.base?"":e.base;return t?r:`${r}/public`},emptyLineTrim=new ctags.TemplateTag(ctags.replaceResultTransformer(/^\s*[\r\n]/gm,""),ctags.trimResultTransformer),htmlTemplate=async e=>compiled(getHtmlFilepath(e),{minimize:!1,escape:!1}),parseHtml=({config:e,ctx:t,dev:r,template:s})=>{const{title:a,description:i}=e,{publicPath:o,css:n,js:l,lang:p="en",favicon:c,head:u=[],body:d=[],trimWhitespace:g}=t,m=`\n    <link rel="stylesheet" type="text/css" href="https://unpkg.com/codemirror@5.39.2/lib/codemirror.css" />\n    ${c?`<link rel="icon" type="image/x-icon" href="${c}">`:""}\n    ${u.meta?generateMetaTags(u.meta):""}\n    ${u.links?generateLinkTags(u.links):""}\n    ${u.raw?generateRawTags(u.raw):""}\n    ${u.scripts?generateScriptTags(u.scripts):""}\n    ${miniHtmlWebpack.generateCSSReferences(n,o)}`,h=`\n    ${d.raw?generateRawTags(d.raw):""}\n    ${d.scripts?generateScriptTags(d.scripts):""}\n    ${miniHtmlWebpack.generateJSReferences(l,o)}`,f=ctags.html(s({title:a,description:i,lang:p,head:m,footer:h,publicUrl:getPublicUrl(e,r)}));return g?ctags.oneLineTrim(f):emptyLineTrim(f)},uglify=new UglifyJs({parallel:!0,cache:!0,sourceMap:!0,uglifyOptions:{parse:{ecma:8},compress:{ecma:5,warnings:!1,comparisons:!1},mangle:{safari10:!0},output:{ecma:5,comments:!1,ascii_only:!0}}}),createConfig=(e,t)=>async r=>{const{debug:s,host:a,port:i}=e,o=new Config,n="production"===t,l=servedPath(e.base),p=getDist(e.dest),c=path.resolve(root,e.src),u=n?l:"/";o.context(root),o.set("mode",t),o.when(s,e=>e.devtool("source-map")),o.when(!n,e=>e.devtool("cheap-module-eval-source-map")),o.node.merge({child_process:"empty",dgram:"empty",fs:"empty",net:"empty",tls:"empty"});o.output.pathinfo(!0).path(path.resolve(root,p)).publicPath(u).when(n,e=>e.filename("static/js/[name].[hash].js").sourceMapFilename("static/js/[name].[hash].js.map").chunkFilename("static/js/[name].[chunkhash:8].js"),e=>e.filename("static/js/[name].js").sourceMapFilename("static/js/[name].js.map")).crossOriginLoading("anonymous"),o.merge({optimization:Object.assign({runtimeChunk:!0,nodeEnv:t,namedModules:!0,noEmitOnErrors:!0,splitChunks:{chunks:"all",name:"vendors"}},n&&{minimize:!0,minimizer:[uglify]})}),o.entry("app").add(require.resolve("@babel/polyfill")).add(indexJs),o.resolve.set("symlinks",!0).extensions.add(".web.js").add(".mjs").add(".js").add(".json").add(".web.jsx").add(".jsx").add(".mdx").end(),e.typescript&&o.resolve.extensions.prepend(".ts").prepend(".tsx").end(),o.resolve.modules.add(ownNodeModules).add(appNodeModules).add("node_modules").add(c).add(root),o.resolveLoader.set("symlinks",!0).modules.add(ownNodeModules).add(appNodeModules).add("node_modules").add(root),js(o,e),mdx(o,e),images(o),svg(o),media(o),fonts(o),e.typescript&&ts(o,e),setupHappypack(o,e,r),o.plugin("assets-plugin").use(manifestPlugin,[{publicPath:u,fileName:"assets.json"}]);const d=!n,g=await htmlTemplate(e.indexHtml);o.plugin("html-plugin").use(miniHtmlWebpack__default,[{context:Object.assign({},e.htmlContext,{trimWhitespace:!0}),template:t=>{const r=parseHtml({ctx:t,dev:d,template:g,config:e});return d?r:htmlMinifier.minify(r,{removeComments:!0,collapseWhitespace:!0,removeRedundantAttributes:!0,useShortDoctype:!0,removeEmptyAttributes:!0,removeStyleLinkTypeAttributes:!0,keepClosingSlash:!0,minifyJS:!0,minifyCSS:!0,minifyURLs:!0})}}]);const m="127.0.0.1"===a||"0.0.0.0"===a?"localhost":a;return o.when(!s&&!n,e=>{e.plugin("webpackbar").use(webpackBarPlugin,[{color:"#41b883",compiledIn:!1,name:"Client"}]),e.plugin("friendly-errors").use(friendlyErrors,[{compilationSuccessInfo:{messages:[`Your application is running at http://${m}:${i}`]}}])}),o.plugin("injections").use(require("webpack/lib/DefinePlugin"),[Object.assign({},getClientEnvironment(l).stringified,{BASE_URL:JSON.stringify(e.hashRouter?"/":l),NODE_ENV:JSON.stringify(t)})]),o.performance.hints(!1),o.toConfig()},devServerConfig=(e,t,r)=>{const s=path.resolve(__dirname,"non-existent"),a=t=>e.debug?"debug":t;return{config:t,host:e.host,port:e.port,content:[s],logLevel:a("error"),devMiddleware:{logLevel:a("silent")},hotClient:{reload:!1,logLevel:a("error"),host:e.hotHost,port:e.hotPort},add:(t,s,a)=>{s.webpack(),s.content(),t.use(range),fs$1.existsSync(appPublic)&&t.use(mount(e.base,serveStatic(appPublic))),t.use(convert(history({rewrites:[{from:/\.html$/,to:"/"}]}))),t.use(serveWaitpage(a,{title:e.title})),r.onCreateApp(t)}}},server=e=>async(t,r)=>{const s=devServerConfig(e,t,r);return{start:async()=>{const e=await serve({},s);return r.OnServerListening(e.app.server),Object.assign({},e,{close:()=>e.app.stop()})}}},{measureFileSizesBeforeBuild:measureFileSizesBeforeBuild,printFileSizesAfterBuild:printFileSizesAfterBuild}=FSR,WARN_AFTER_BUNDLE_GZIP_SIZE=524288,WARN_AFTER_CHUNK_GZIP_SIZE=1048576,hasCiEnvVar=()=>envDotProp.get("ci",!1,{parse:!0}),copyPublicFolder=async e=>{await fs$1.pathExists(appPublic)&&await fs$1.copySync(appPublic,distPublic(e),{dereference:!0,filter:e=>e!==indexHtml})},compile=e=>new Promise((t,r)=>{let s;try{s=webpack(e)}catch(e){onError(e)}s&&s.run((e,s)=>{e&&r(e),t(s)})}),builder=async(e,t)=>(logger.start("Creating an optimized production build..."),new Promise(async(r,s)=>{try{const a=await compile(e),i=formatWebpackMessages(a.toJson({},!0));return i.errors.length?s(Error(i.errors.join("\n\n"))):hasCiEnvVar()&&i.warnings.length?(logger.warn("\nTreating warnings as errors because process.env.CI = true.\nMost CI servers set it automatically.\n"),s(Error(i.warnings.join("\n\n")))):r({stats:a,previousFileSizes:t,warnings:i.warnings})}catch(e){s(e)}})),onSuccess=(e,{stats:t,previousFileSizes:r,warnings:s})=>{s.length?(logger.warn("Compiled with warnings.\n"),logger.warn(s.join("\n\n")),logger.warn("\nSearch for the "+chalk.underline(chalk.yellow("keywords"))+" to learn more about each warning."),logger.warn("To ignore, add "+chalk.cyan("// eslint-disable-next-line")+" to the line before.\n")):logger.success(chalk.green("Compiled successfully.\n")),logger.log("File sizes after gzip:\n"),printFileSizesAfterBuild(t,r,e,524288,1048576),logger.log()},onError=e=>{logger.fatal(chalk.red("Failed to compile.\n")),printBuildError(e),process.exit(1)},build=async(e,t)=>{try{await fs$1.ensureDir(t);const r=await measureFileSizesBeforeBuild(t);await fs$1.emptyDir(t),await copyPublicFolder(t);const s=await builder(e,r);onSuccess(t,s)}catch(e){onError(e)}},bundler=(e,t)=>new Bundler({args:e,build:build,config:createConfig(e,t),server:server(e)}),toOmit=["_","$0","version","help"],defaultHtmlContext={lang:"en"},loadConfig=e=>{const t=loadCfg.load("docz",Object.assign({},e,{hashRouter:!1,native:!1,plugins:[],mdPlugins:[],hastPlugins:[],themeConfig:{},htmlContext:defaultHtmlContext,modifyBundlerConfig:e=>e,modifyBabelRc:e=>e})),r=Plugin.reduceFromPlugins(t.plugins);return omit(toOmit,r("setConfig",Object.assign({},t,{paths:paths})))},dev=async e=>{const t=envDotProp.get("node.env"),r=loadConfig(e),s=await detectPort(r.port),a=await detectPort(r.hotPort),i=await detectPort(r.websocketPort);envDotProp.set("webpack.server.overlay.ws.url",`ws://${r.hotHost}:${a}`);const o=Object.assign({},r,{websocketPort:i,hotPort:a,port:s}),n=bundler(o,t),l=await n.getConfig(t),p=await n.createServer(l),{app:c}=await p.start(),u=new DataServer(c.server,i,r.websocketHost);try{u.register([state(o),state$1(o)]),await Entries.writeApp(o,!0),await u.init(),await u.listen()}catch(e){logger.fatal("Failed to process your server:",e),process.exit(1)}},build$1=async e=>{const t=envDotProp.get("node.env"),r=loadConfig(e),s=bundler(r,t),a=Plugin.runPluginsMethod(r.plugins),i=new DataServer;try{i.register([state(r),state$1(r)]),await Entries.writeApp(r),await i.init(),await a("onPreBuild",r),await s.build(await s.getConfig(t)),await a("onPostBuild",r)}catch(e){logger.fatal(e),process.exit(1)}};var index=Object.freeze({dev:dev,build:build$1});const getEnv=(e,t=null)=>envDotProp.get(e,t,{parse:!0}),removeScope=e=>e.replace(/^@.*\//,""),getInitialTitle=e=>{const t=get(e,"name")||"MyDoc";return titleize(humanize(removeScope(t)))},getInitialDescription=e=>get(e,"description")||"My awesome app using docz",args=e=>t=>{const r=fs$1.readJsonSync(appPackageJson,{throws:!1});setEnv(e),t.positional("base",{type:"string",default:getEnv("docz.base","/")}),t.positional("source",{alias:"src",type:"string",default:getEnv("docz.source","./")}),t.positional("files",{type:"string",default:getEnv("docz.files","**/*.mdx")}),t.positional("ignore",{type:"array",default:getEnv("docz.ignore",[])}),t.positional("dest",{alias:"d",type:"string",default:getEnv("docz.dest",".docz/dist")}),t.positional("editBranch",{alias:"eb",type:"string",default:getEnv("docz.edit.branch","master")}),t.positional("title",{type:"string",default:getEnv("docz.title",getInitialTitle(r))}),t.positional("description",{type:"string",default:getEnv("docz.description",getInitialDescription(r))}),t.positional("theme",{type:"string",default:getEnv("docz.theme","docz-theme-default")}),t.positional("typescript",{alias:"ts",type:"boolean",default:getEnv("docz.typescript",!1)}),t.positional("propsParser",{type:"boolean",default:getEnv("docz.props.parser",!0)}),t.positional("wrapper",{type:"string",default:getEnv("docz.wrapper",null)}),t.positional("indexHtml",{type:"string",default:getEnv("docz.index.html",null)}),t.positional("ordering",{type:"string",default:getEnv("docz.ordering","descending")}),t.positional("debug",{type:"boolean",default:getEnv("docz.debug",!1)}),t.positional("host",{type:"string",default:getEnv("docz.host","127.0.0.1")}),t.positional("port",{alias:"p",type:"number",default:getEnv("docz.port",3e3)}),t.positional("hotHost",{type:"string",default:getEnv("docz.hot.host","127.0.0.1")}),t.positional("hotPort",{type:"number",default:getEnv("docz.hot.port",60757)}),t.positional("websocketHost",{type:"string",default:getEnv("docz.websocket.host","127.0.0.1")}),t.positional("websocketPort",{type:"number",default:getEnv("docz.websocket.port",60505)}),t.positional("native",{type:"boolean",default:getEnv("docz.native",!1)})};exports.commands=index,exports.args=args,exports.setEnv=setEnv,exports.Plugin=Plugin,exports.createPlugin=createPlugin;
